<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Torre</title>
	<link rel="stylesheet" type="text/css" href="styles/estilos.css">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.2.2/cropper.min.css" rel="stylesheet">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
		integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

</head>

<body>
	<!-- Sección principal  -->
	<div id="mainFace">
		<h1>Torres de Hanoi</h1>
		<!-- Agregar el nombre de Usuario -->
		<form class="was-validated">
			<div class="form-row">
				<input type="text" class="form-control" id="username" placeholder="Nombre de usuario" required>
			</div>
		</form>
		<br>
		<!-- Seleccionar con cuántos aros se jugará -->
		<p>¿Con cuántos aros deseas jugar?</p>
		<form class="was-validated">
			<div class="form-group">
				<select class="custom-select" required id="select_aros">
					<option value="">Selecciona el número de aros</option>
					<option value="uno">Uno (1)</option>
					<option value="dos">Dos (2)</option>
					<option value="tres">Tres (3)</option>
					<option value="cuatro">Cuatro (4)</option>
					<option value="cinco">Cinco (5)</option>
					<option value="seis">Seis (6)</option>
					<option value="siete">Siete (7)</option>
					<option value="ocho">Ocho (8)</option>
				</select>
			</div>
			<!-- Botón de inicio -->
			<a class="btn btn-primary" type="submit" id="start">INICIO</a>
		</form>
	</div>
	<!-- Juego -->
	<div id="game">
		<div id="bg"></div>
		<div id="juego">
			<!-- Todos los aros -->
			<div class="aro" id="drag1"></div>
			<div class="aro" id="drag2"></div>
			<div class="aro" id="drag3"></div>
			<div class="aro" id="drag4"></div>
			<div class="aro" id="drag5"></div>
			<div class="aro" id="drag6"></div>
			<div class="aro" id="drag7"></div>
			<div class="aro" id="drag8"></div>
			<!-- Todas las torres -->
			<div class="tower" id="tower1">
				<div class="torre"></div>
			</div>
			<div class="tower" id="tower2">
				<div class="torre"></div>
			</div>
			<div class="tower" id="tower3">
				<div class="torre"></div>
			</div>
		</div>

		<!-- Muestra el nombre del usuario  -->
		<h2 id="user"></h2>
		<!-- Muestra los puntos que llevas -->
		<div class="points">
			<div class="datos">
				<!-- Muestra el número de movimientos -->
				<p>Numero de jugadas: <span id="jugadas"></span></p>
				<!-- Muestra el tiempo desde que se dió inicio -->
				<p>Tiempo: <span id="minutos">00</span>:<span id="segundos">00</span></p>
			</div>
			<!-- Control de pausa y reinicio -->
			<div class="controls">
				<!-- Botón de pausa -->
				<a type="button" class="btn btn-success" id="pause">Pausa</a>
				<br>
				<!-- Botón de reinicio -->
				<a href="index.html" type="button" class="btn btn-danger" id="restart">Reiniciar</a>
			</div>
		</div>
	</div>


	<!-- Pantalla de juego pausado -->
	<div id="pauseFace">
		<h2>Juego Pausado</h2>
		<!-- Botón de continuar con el juego -->
		<a type="button" class="btn btn-success" id="resume">Continuar</a>
	</div>

	<!-- Pantalla de ganador -->
	<div id="winFace">
		<h2>¡Felicitaciones!</h2>
		<!-- Muestra los resultados -->
		<div class="result">
			<!-- Muestra el tiempo que se tardó en resolver el juego -->
			<div class="tiempo">
				<h3>Tiempo</h3>
				<p id="time"></p>
			</div>
			<!-- Muestra el número de movimientos que realizó -->
			<div class="jugadas">
				<h3>Jugadas</h3>
				<p id="moves"></p>
			</div>
		</div>
		<a href="index.html" class="btn start">Volver a Jugar</a>
	</div>

	<script type="text/javascript" src="lib/jquery.js"></script>
	<script type="text/javascript" src="lib/jquery-ui.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
		integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
		crossorigin="anonymous"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.2.2/cropper.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.8.2/firebase.js"></script>


	<script>
		// Initialize Firebase
		let fr
		let cropper
		var config = {
			apiKey: "AIzaSyA3gNnDJMZomlyhLeCgoea83IWHNRUUgwg",
			authDomain: "torre-migue.firebaseapp.com",
			databaseURL: "https://torre-migue.firebaseio.com",
			projectId: "torre-migue",
			storageBucket: "torre-migue.appspot.com",
			messagingSenderId: "240479977873",
			appId: "1:240479977873:web:0d109f6ec654f2428eda30",
			measurementId: "G-5SYGNHVK6Z"
		};
		firebase.initializeApp(config)
		const levelsInSpanish = {
			uno: 'Uno',
			dos: 'Dos',
			tres: 'Tres',
			cuatro: 'Cuatro',
			cinco: 'Cinco',
			seis: 'Seis',
			siete: 'Siete',
			ocho: 'Ocho'
		}
		let dataLevels = {
			uno: [],
			dos: [],
			tres: [],
			cuatro: [],
			cinco: [],
			seis: [],
			siete: [],
			ocho: []
		}
		const levels = Object.keys(dataLevels)
		function orderArray(arr) {
			let pos = 1, counter = 0
			arr.sort(compare)
			console.log(arr)
			let last = null
			arr.forEach(e => {
				counter++
				e.count = counter
				if (!last) {
					e.pos = 1
					last = e
				} else {
					if (last.minutos == e.minutos && last.jugadas == e.jugadas && last.segundos == e.segundos) {
						e.pos = last.pos
					} else e.pos = last.pos + 1
					last = e
				}
			})
			return arr.filter(e => e.count < 11)
		}
		function renderizar(level) {
			$('#resultLevel').text(levelsInSpanish[level])
			$('#rankingTable').html('')
			for (const iterable of dataLevels[level]) {
				const html = `
					<tr class="user-row">
						<td>${iterable.pos}º</td>
						<td class="image-td">
							<img src="${iterable.userImage}" alt="imagen">
						</td>
						<td>${iterable.username}</td>
						<td>${iterable.minutos}:${iterable.segundos} m</td>
						<td>${iterable.jugadas}</td>
					</tr>`
				$('#rankingTable').append(html)
			}
		}
		async function createListener(level) {
			const levelsNoPlay = levels.filter(e => e !== level)
			levelsNoPlay.forEach(e => {
				firebase.database().ref(e).off('child_added')
			})
			firebase.database().ref(level).on("child_added", snap => {
				console.log('add')
				const data = snap.val()
				console.log(data)
				dataLevels[level].push(data)
				dataLevels[level] = orderArray(dataLevels[level])
				renderizar(level)
			})
		}
		function compare(a, b) {
			if (a.minutos < b.minutos) return -1
			else if (a.minutos > b.minutos) return 1
			else {
				if (a.segundos < b.segundos) return -1
				else if (a.segundos > b.segundos) return 1
				else {
					if (a.jugadas < b.jugadas) return -1
					else if (a.jugadas > b.jugadas) return 1
					else return 0
				}
			}
		}
	</script>
	<script type="module" src="js/index.js"></script>
</body>

</html>